import{l as B,J as L,K as R,L as A,M as P,P as M,F as $}from"./vendor-fortawesome-63a0ad05.js";import{C as E}from"./index-13aad0d9.js";import{C as I,p as H,a as z,L as V,b as T,P as F,c as N,T as J,i as Z,d as G,e as U}from"./vendor-chartjs-f0fbe832.js";import{_ as Q,p as y,k as u,l as h,q as S,A as m,L as f,y as C,u as D,G as w,I as _,x as k}from"./vendor-20bb207d.js";import"./vendor-bootstrap-d275de6c.js";import"./vendor-jquery-89b63fca.js";import"./vendor-axios-13ef03ae.js";import"./vendor-sortablejs-ad1d2cc8.js";import"./vendor-luxon-1af9332f.js";B.add(L,R,A,P,M);I.register(H,z,V,T,F,N,J,Z,G);const Y={name:"OpenwbDailyChart",components:{ChartjsLine:U,FontAwesomeIcon:$},mixins:[E],emits:["sendCommand"],data(){return{mqttTopicsToSubscribe:["openWB/general/extern","openWB/log/daily/#","openWB/system/device/+/component/+/config","openWB/chargepoint/+/config","openWB/vehicle/+/name"],currentDay:"",dailyChartRequestData:{day:"",month:"",year:""},datasetTemplates:{"counter-power":{label:"Zähler",unit:"kW",jsonKey:null,borderColor:"rgba(255, 0, 0, 0.7)",backgroundColor:"rgba(255, 10, 13, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!1,borderWidth:1,data:null,yAxisID:"y",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"pv-power":{label:"PV",unit:"kW",jsonKey:null,borderColor:"rgba(0, 255, 0, 0.7)",backgroundColor:"rgba(10, 255, 13, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!1,borderWidth:1,data:null,yAxisID:"y",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"bat-power":{label:"Speicher",unit:"kW",jsonKey:null,borderColor:"rgba(255, 153, 13, 0.7)",backgroundColor:"rgba(200, 255, 13, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!1,borderWidth:1,data:null,yAxisID:"y",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"bat-soc":{label:"Speicher SoC",unit:"%",jsonKey:null,borderColor:"rgba(255, 153, 13, 0.7)",backgroundColor:"rgba(200, 255, 13, 0.3)",borderDash:[10,5],hidden:!1,fill:!1,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",borderWidth:2,data:null,yAxisID:"y2",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"cp-power":{label:"Ladepunkt",unit:"kW",jsonKey:null,borderColor:"rgba(0, 0, 255, 0.7)",backgroundColor:"rgba(0, 0, 255, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!0,borderWidth:1,data:null,yAxisID:"y",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"ev-soc":{label:"Fahrzeug SoC",unit:"%",jsonKey:null,borderColor:"rgba(0, 0, 255, 0.7)",backgroundColor:"rgba(0, 0, 255, 0.3)",borderDash:[10,5],hidden:!0,fill:!1,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",borderWidth:2,data:null,yAxisID:"y2",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"sh-power":{label:"SmartHome",unit:"kW",jsonKey:null,borderColor:"rgba(232, 62, 140, 0.7)",backgroundColor:"rgba(232, 72, 150, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!1,borderWidth:1,data:null,yAxisID:"y",parsing:{xAxisKey:"timestamp",yAxisKey:null}}},chartOptions:{plugins:{title:{display:!1},tooltip:{enabled:!0,callbacks:{label:e=>`${e.dataset.label}: ${e.formattedValue} ${e.dataset.unit}`}},legend:{display:!0},zoom:{pan:{enabled:!0,mode:"x",threshold:5},zoom:{wheel:{enabled:!0},pinch:{enabled:!0},mode:"x"}}},elements:{point:{radius:2}},responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},scales:{x:{type:"time",time:{unit:"minute",tooltipFormat:"DD T"},display:!0,title:{display:!0,text:"Zeit"},ticks:{source:"timestamp",font:{size:12},maxTicksLimit:24},grid:{}},y:{position:"left",type:"linear",display:"auto",suggestedMin:0,suggestedMax:0,title:{font:{size:12},display:!0,text:"Leistung [kW]"},grid:{},ticks:{font:{size:12},stepSize:.2,maxTicksLimit:11}},y2:{position:"right",type:"linear",display:"auto",suggestedMin:0,suggestedMax:100,title:{font:{size:12},display:!0,text:"SoC [%]"},grid:{display:!1},ticks:{font:{size:12},stepSize:10,maxTicksLimit:11}}}},chartDatasets:{datasets:[]}}},computed:{dailyChartDate:{get(){return this.dailyChartRequestData.year+"-"+this.dailyChartRequestData.month+"-"+this.dailyChartRequestData.day},set(e){let o=e.split("-");this.dailyChartRequestData.year=o[0],this.dailyChartRequestData.month=o[1],this.dailyChartRequestData.day=o[2]}},commandData(){return{day:this.dailyChartRequestData.year+this.dailyChartRequestData.month+this.dailyChartRequestData.day}},chartDataRead(){return this.chartDataObject!=null},chartDataHasEntries(){return this.chartDataObject?this.chartDataObject.length>0:!1},chartTotals(){if(this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day]){if(Object.prototype.hasOwnProperty.call(this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day],"totals"))return this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day].totals;{var e={bat:{},counter:{},pv:{},cp:{}};const t=["imported","exported"],l=(d,a,r)=>{const p=r.split(".");t.includes(p[p.length-1])&&(Object.prototype.hasOwnProperty.call(e[p[0]],[p[1]])||(e[p[0]][p[1]]={}),e[p[0]][p[1]][p[2]]=Math.floor(a-d))},i=(d,a,r,p="")=>{for(var c in a)a[c]!==null&&typeof a[c]=="object"?i(d[c],a[c],r,p?p+"."+c:c):r.apply(this,[d[c],a[c],p?p+"."+c:c])};var o=this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day];const s=o[0],n=o[o.length-1];return i(s,n,l),e}}},chartDataObject(){if(this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day]){var e=this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day];Object.prototype.hasOwnProperty.call(e,"entries")&&(console.debug("upgraded chart data received"),e=e.entries);var o=JSON.parse(JSON.stringify(e)).map((t,l,i)=>{if(i.length>l+1){const n=i[l+1];t.timestamp=t.timestamp*1e3;const d=n.timestamp*1e3-t.timestamp;var s=["pv","counter","bat","cp","sh"];return s.forEach(a=>{Object.entries(t[a]).forEach(([r,p])=>{t[a][r]&&Object.keys(p).forEach(()=>{switch(a){case"pv":Object.prototype.hasOwnProperty.call(n[a][r],"exported")&&Object.prototype.hasOwnProperty.call(t[a][r],"exported")&&(t[a][r].power=Math.floor((n[a][r].exported-t[a][r].exported)/(d/1e3/3600))/1e3);break;case"counter":Object.prototype.hasOwnProperty.call(n[a][r],"imported")&&Object.prototype.hasOwnProperty.call(t[a][r],"imported")&&Object.prototype.hasOwnProperty.call(n[a][r],"exported")&&Object.prototype.hasOwnProperty.call(t[a][r],"exported")&&(t[a][r].power=Math.floor((n[a][r].imported-t[a][r].imported-(n[a][r].exported-t[a][r].exported))/(d/1e3/3600))/1e3,t[a][r].powerImport=Math.max(0,t[a][r].power),t[a][r].powerExport=Math.min(0,t[a][r].power));break;case"bat":Object.prototype.hasOwnProperty.call(n[a][r],"imported")&&Object.prototype.hasOwnProperty.call(t[a][r],"imported")&&Object.prototype.hasOwnProperty.call(n[a][r],"exported")&&Object.prototype.hasOwnProperty.call(t[a][r],"exported")&&(t[a][r].power=Math.floor((n[a][r].imported-t[a][r].imported-(n[a][r].exported-t[a][r].exported))/(d/1e3/3600))/1e3,t[a][r].powerImport=Math.max(0,t[a][r].power),t[a][r].powerExport=Math.min(0,t[a][r].power));break;case"cp":Object.prototype.hasOwnProperty.call(n[a][r],"imported")&&Object.prototype.hasOwnProperty.call(t[a][r],"imported")&&(t[a][r].power=Math.floor((n[a][r].imported-t[a][r].imported)/(d/1e3/3600))/1e3);break;case"sh":Object.prototype.hasOwnProperty.call(n[a][r],"imported")&&Object.prototype.hasOwnProperty.call(t[a][r],"imported")&&Object.prototype.hasOwnProperty.call(n[a][r],"exported")&&Object.prototype.hasOwnProperty.call(t[a][r],"exported")&&(t[a][r].power=Math.floor((n[a][r].imported-t[a][r].imported-(n[a][r].exported-t[a][r].exported))/(d/1e3/3600))/1e3,t[a][r].powerImport=Math.max(0,t[a][r].power),t[a][r].powerExport=Math.min(0,t[a][r].power));break}})})}),t}else return});return o.pop(),o}},chartData(){if(this.chartDataObject){var e=["pv","counter","bat","cp","sh","ev"];const o=this.chartDataObject[this.chartDataObject.length-1];return o&&e.forEach(t=>{Object.entries(o[t]).forEach(([l,i])=>{Object.keys(i).forEach(s=>{this.initDataset(t,l,s)})})}),this.chartDatasets}}},methods:{getCardSubtype(e){switch(e){case"bat":return"warning";case"counter":return"danger";case"cp":return"primary";case"pv":return"success";case"sh":return"pink";default:return"secondary"}},getCardIcon(e){switch(e){case"bat":return["fas","car-battery"];case"counter":return["fas","gauge-high"];case"cp":return["fas","charging-station"];case"pv":return["fas","solar-panel"];case"sh":return["fas","house-signal"];default:return}},getDatasetHidden(e,o){return console.debug("getDatasetHidden",e,o),!1},getTotalsLabel(e,o=void 0,t=void 0){var l="*test*";if(!o&&!t){switch(e){case"bat":return"Speicher";case"counter":return"Zähler";case"pv":return"Wechselrichter";case"cp":return"Ladepunkte";case"sh":return"SmartHome-Geräte";default:console.warn("unknown group key:",e)}return"*"+e+"*"}if(o&&!t){if(o=="all")return"Summe";if(Object.prototype.hasOwnProperty.call(this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day],"names"))return this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day].names[o];var i=o.match(/\d+$/),s="";switch(e){case"cp":s="openWB/chargepoint/"+i+"/config";break;case"ev":s="openWB/vehicle/"+i+"/name";break;default:s="openWB/system/device/+/component/"+i+"/config"}var n=Object.keys(this.getWildcardTopics(s))[0];if(n)switch(e){case"pv":return this.$store.state.mqtt[n].name;case"counter":return this.$store.state.mqtt[n].name;case"bat":return this.$store.state.mqtt[n].name;case"cp":return this.$store.state.mqtt[n].name;case"ev":return this.$store.state.mqtt[n];case"sh":return"SmartHome*";default:console.warn("unknown group key:",e)}else console.warn("topic not found for:",e,o);return"+"+e+"+"+o+"+"}if(o&&t){switch(e){case"bat":case"cp":switch(t){case"imported":return"Ladung";case"exported":return"Entladung";default:console.warn("unknown measurement key:",e,t)}break;case"counter":switch(t){case"imported":return"Bezug/Verbrauch";case"exported":return"Einspeisung/Erzeugung";default:console.warn("unknown measurement key:",e,t)}break;case"pv":switch(t){case"exported":return"Erzeugung";default:console.warn("unknown measurement key:",e,t)}break;case"sh":switch(t){case"imported":return"Verbrauch";case"exported":return"Erzeugung";default:console.warn("unknown measurement key:",e,t)}break;default:console.warn("unknown group key:",e)}return"*"+e+"+"+o+"+"+t+"*"}return l},getDatasetLabel(e,o,t,l){var i=["*"+l],s=[];if(o=="all")switch(s.push("Summe"),e){case"pv":i=["PV"];break;case"bat":switch(i=["Speicher"],t){case"soc":i.push("SoC");break}break;case"cp":switch(i=["Ladepunkte"],t){case"soc":i.push("SoC");break}break}else if(Object.prototype.hasOwnProperty.call(this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day],"names")&&Object.prototype.hasOwnProperty.call(this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day].names,o))i=[this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day].names[o]];else{var n=o.match(/\d+$/),d="";switch(e){case"cp":d="openWB/chargepoint/"+n+"/config";break;case"ev":d="openWB/vehicle/"+n+"/name";break;default:d="openWB/system/device/+/component/"+n+"/config"}var a=Object.keys(this.getWildcardTopics(d))[0];if(a in this.$store.state.mqtt)switch(e){case"pv":i=[this.$store.state.mqtt[a].name];break;case"counter":i=[this.$store.state.mqtt[a].name];break;case"bat":switch(i=[this.$store.state.mqtt[a].name],t){case"soc":i.push("SoC");break}break;case"cp":switch(i=[this.$store.state.mqtt[a].name],t){case"soc":i.push("SoC");break}break;case"sh":switch(i=[this.$store.state.mqtt[a].name],t){case"temp1":case"temp2":case"temp3":i.push(t.charAt(0).toUpperCase()+t.substring(1));break}break;case"ev":switch(i=[this.$store.state.mqtt[a]],t){case"soc":i.push("SoC");break}break}else console.warn("could not get name for dataset",l)}switch(e){case"bat":case"cp":switch(t){case"imported":case"energyImport":s.push("Ladung");break;case"exported":case"energyExport":s.push("Entladung");break}break;case"counter":switch(t){case"imported":case"energyImport":s.push("Bezug/Verbrauch");break;case"exported":case"energyExport":s.push("Einspeisung/Erzeugung");break}break}return console.debug("getDatasetLabel",e,o,t,l,"Label:",i,s),`${i.join(" ")}${s.length?" ("+s.join(", ")+")":""}`},getDatasetIndex(e){let o=this.chartDatasets.datasets.findIndex(t=>t.jsonKey==e);if(o!=-1)return o},addDataset(e,o,t,l){console.debug("adding new dataset",e,o,t,l);var i=e+"-"+t;if(this.datasetTemplates[i]){var s=JSON.parse(JSON.stringify(this.datasetTemplates[i]));return s.parsing.yAxisKey=l,s.jsonKey=l,s.data=this.chartDataObject,s.label=this.getDatasetLabel(e,o,t,l),s.labelSuffix!=null&&(s.label=s.label+s.labelSuffix),o=="all"&&(s.hidden=!1),this.chartDatasets.datasets.push(s)-1}else console.warn("no matching template found for: "+l+" with template: "+i)},initDataset(e,o,t){const l=["power","soc"],i=e+"."+o+"."+t;if(l.includes(t)){var s=this.getDatasetIndex(i);const n=this.getDatasetHidden(e,o);s==null&&!n&&(s=this.addDataset(e,o,t,i)),s!=null&&n&&(console.info("component hidden:",e,o,t,s),this.chartDatasets.datasets.splice(s,1))}},requestDailyChart(){if(document.forms.dailyChartForm.reportValidity())this.chartDatasets.datasets=[],this.$emit("sendCommand",{command:"getDailyLog",data:this.commandData});else{console.log("form invalid");return}},clearChartData(){this.getWildcardIndexList("openWB/log/daily/+").forEach(e=>{this.$store.commit("removeTopic",`openWB/log/daily/${e}`)})},updateChart(){this.clearChartData(),this.requestDailyChart()}},mounted(){const e=new Date;this.currentDay=this.dailyChartDate=e.getFullYear()+"-"+String(e.getMonth()+1).padStart(2,"0")+"-"+String(e.getDate()).padStart(2,"0"),this.requestDailyChart()}},X={class:"dailyChart"},O={name:"dailyChartForm"},j={key:1},K={key:1},tt={class:"openwb-chart"};function at(e,o,t,l,i,s){const n=y("openwb-base-text-input"),d=y("openwb-base-card"),a=y("openwb-base-alert"),r=y("chartjs-line"),p=y("font-awesome-icon"),c=y("openwb-base-heading");return u(),h("div",X,[S("form",O,[m(d,{title:"Filter",collapsible:!0,collapsed:!1},{default:f(()=>[m(n,{title:"Datum",subtype:"date",min:"2018-01-01",max:i.currentDay,showQuickButtons:!0,modelValue:s.dailyChartDate,"onUpdate:modelValue":[o[0]||(o[0]=x=>s.dailyChartDate=x),o[1]||(o[1]=x=>s.updateChart())]},null,8,["max","modelValue"])]),_:1}),s.chartDataRead?(u(),h("div",j,[s.chartDataHasEntries?(u(),h("div",K,[m(d,{title:"Diagramm",collapsible:!0,collapsed:!1},{default:f(()=>[S("div",tt,[m(r,{data:s.chartData,options:i.chartOptions},null,8,["data","options"])])]),_:1}),m(d,{title:"Summen",collapsible:!0,collapsed:!0},{default:f(()=>[(u(!0),h(w,null,_(s.chartTotals,(x,g)=>(u(),C(d,{key:g,collapsible:!0,collapsed:!0,subtype:s.getCardSubtype(g)},{header:f(()=>[m(p,{"fixed-width":"",icon:s.getCardIcon(g)},null,8,["icon"]),D(" "+k(s.getTotalsLabel(g)),1)]),default:f(()=>[(u(!0),h(w,null,_(x,(W,v)=>(u(),h("div",{key:v},[m(c,null,{default:f(()=>[D(k(s.getTotalsLabel(g,v)),1)]),_:2},1024),(u(!0),h(w,null,_(W,(q,b)=>(u(),h("div",{key:b},[m(n,{title:s.getTotalsLabel(g,v,b),readonly:"",class:"text-right",unit:"kWh","model-value":e.formatNumber(q/1e3,3)},null,8,["title","model-value"])]))),128))]))),128))]),_:2},1032,["subtype"]))),128))]),_:1})])):(u(),C(a,{key:0,subtype:"info"},{default:f(()=>[D(" Es konnten keine Daten für diesen Zeitraum gefunden werden. ")]),_:1}))])):(u(),C(a,{key:0,subtype:"info"},{default:f(()=>[D(" Es wurden noch keine Daten abgerufen. ")]),_:1}))])])}const ct=Q(Y,[["render",at],["__scopeId","data-v-cea01f9f"],["__file","/opt/openWB-dev/openwb-ui-settings/src/views/DailyChart.vue"]]);export{ct as default};
